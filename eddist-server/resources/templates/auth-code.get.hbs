<!DOCTYPE html>
<html lang="ja">
<head>
    <title>コード認証画面</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    {{#if cf_site_key}}
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    {{/if}}
    {{#if hcaptcha_site_key}}
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    {{/if}}
    {{#if monocle_site_key}}
    <script async
        src="https://mcl.spur.us/d/mcl.js?tk={{monocle_site_key}}"
        id="_mcl"></script>
    {{/if}}
</head>
<body class="bg-gray-50">
    <div class="min-h-[calc(100vh-1rem)] lg:min-h-[calc(100vh-4rem)] flex flex-col max-w-4xl mx-auto p-4">
        <article class="flex-1">
            <header class="text-center py-8">
                <h1 class="text-3xl lg:text-5xl font-bold text-gray-900 mb-4">コード認証</h1>
                <div class="border-b border-gray-300 w-full"></div>
            </header>
            
            <section class="py-8">
                <div class="bg-white rounded-lg shadow-sm border p-6 lg:p-8 space-y-6">
                    <div class="space-y-4">
                        <h2 class="text-2xl lg:text-3xl font-semibold text-gray-900">利用規約への同意</h2>
                        <p class="text-gray-700 lg:text-lg leading-relaxed">
                            認証を進める前に以下の利用規約を確認して、同意する必要があります。
                        </p>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <button 
                                id="show-tou-btn" 
                                type="button"
                                class="text-blue-600 hover:text-blue-800 font-medium lg:text-lg underline decoration-blue-600"
                            >
                                利用規約を確認して同意する
                            </button>
                        </div>
                        <div id="tou-status" class="hidden">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <p class="text-green-800 font-medium lg:text-lg">
                                    利用規約に同意しました
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-6">
                        <h2 class="text-2xl lg:text-3xl font-semibold text-gray-900 mb-4">認証手順</h2>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                            <p class="text-gray-700 lg:text-lg leading-relaxed">
                                認証を進めるために、事前に書き込みを行い6桁の認証コードを取得してください
                            </p>
                        </div>

                        <form action="/auth-code" method="POST" id="login-form" class="monocle-enriched space-y-6">
                            {{#if cf_site_key}}
                            <div class="flex justify-center">
                                <div class="cf-turnstile" data-sitekey="{{cf_site_key}}" data-theme="light"></div>
                            </div>
                            {{/if}}
                            {{#if hcaptcha_site_key}}
                            <div class="flex justify-center">
                                <div class="h-captcha" data-sitekey="{{hcaptcha_site_key}}"></div>
                            </div>
                            {{/if}}
                            
                            <div class="space-y-2">
                                <label for="auth-code" class="block text-sm font-medium text-gray-900">認証コード</label>
                                <input 
                                    type="number" 
                                    name="auth-code" 
                                    id="auth-code"
                                    placeholder="6桁の認証コード"
                                    maxlength="6"
                                    class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center font-mono"
                                    required
                                >
                            </div>
                            
                            <button 
                                type="submit" 
                                id="submit-btn"
                                disabled
                                class="w-full bg-gray-400 text-white font-semibold py-3 px-6 rounded-lg lg:text-lg cursor-not-allowed"
                            >
                                利用規約に同意して認証を行う
                            </button>
                        </form>
                    </div>
                </div>
            </section>
        </article>
        
        <footer class="py-6 text-center mt-8">
            <p class="text-xs text-gray-400">
                This BBS is powered by 
                <a href="https://github.com/edginer/eddist" class="text-gray-500 hover:text-gray-700 underline">
                    Eddist
                </a>
            </p>
        </footer>
    </div>

    <!-- Terms of Use Modal -->
    <div id="tou-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] flex flex-col">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-900">利用規約</h2>
                </div>
                
                <div id="tou-content" class="flex-1 p-6 overflow-y-auto text-sm leading-relaxed">
                    <h3 class="text-lg font-semibold mb-4">第1条（適用範囲）</h3>
                    <p class="mb-4">本利用規約（以下「本規約」といいます）は、当掲示板（以下「本サービス」といいます）を利用するすべてのユーザー（以下「利用者」といいます）に適用されます。利用者は、本サービスを利用することにより、本規約に同意したものとみなされます。</p>

                    <h3 class="text-lg font-semibold mb-4">第2条（収集する情報）</h3>
                    <p class="mb-2">本サービスは、利用者のIPアドレス、Cookie、その他端末を特定するための情報を収集し、以下の目的で使用します。</p>
                    <ol class="list-decimal list-inside mb-4 space-y-1">
                        <li>本サービスの運営及び管理</li>
                        <li>不正利用の防止及びセキュリティの向上</li>
                        <li>サービスの改善及び提供内容の最適化</li>
                    </ol>
                    <p class="mb-2">これらの情報は、本サービス運営のためにのみ利用され、以下の場合に加えて法執行機関等からの正当な要求に応じる場合、または利用者が同意した場合を除き、第三者に提供することはありません。</p>
                    <ol class="list-decimal list-inside mb-4">
                        <li>書き込み時、また書き込み前の認証時に利用者の正当性を確認するために、いくつかのサービス(*1)に問い合わせる場合</li>
                    </ol>

                    <h3 class="text-lg font-semibold mb-4">第3条（書き込みの責任）</h3>
                    <p class="mb-4">本サービスにおけるすべての書き込み（テキスト、画像、その他の情報を含む）は、その書き込みを行った利用者に全責任が属します。利用者は、以下に定める違法な書き込みや不適切な内容を投稿しないことに同意するものとします。</p>

                    <h3 class="text-lg font-semibold mb-4">第4条（禁止事項）</h3>
                    <p class="mb-2">利用者は、以下の行為を行ってはなりません。</p>
                    <ol class="list-decimal list-inside mb-4 space-y-2">
                        <li><strong>違法な書き込み</strong>
                            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                                <li>名誉毀損、中傷、侮辱、脅迫など、他者の権利や名誉を侵害する内容</li>
                                <li>著作権、商標権、特許権、プライバシー権、肖像権などの知的財産権を侵害する内容</li>
                                <li>無断で個人情報（氏名、住所、電話番号、メールアドレスなど）を公開する行為</li>
                                <li>法律で禁止されている行為を助長する内容や、犯罪行為に関与する内容</li>
                            </ul>
                        </li>
                        <li><strong>その他不適切な書き込み</strong>
                            <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                                <li>過度に暴力的な表現、残虐な表現、児童ポルノを含む内容</li>
                                <li>虚偽の情報を流布し、混乱や誤解を招く内容</li>
                                <li>スパム、商業目的の宣伝、不正アクセス行為に関与する内容</li>
                                <li>スクリプトやbotなどを用いた自動書き込み行為</li>
                                <li>人種、民族、国籍、性別、宗教、障害、性的指向などに対する差別的な発言</li>
                            </ul>
                        </li>
                    </ol>

                    <h3 class="text-lg font-semibold mb-4">第5条（著作権）</h3>
                    <p class="mb-4">利用者が本サービスに投稿した書き込みの著作権は、書き込みを行った利用者自身に属します。ただし、利用者は本サービス及び本サービスの関連サービス(*2)で投稿内容を使用、複製、編集、公開することについて、運営者に対して無期限かつ無償で非独占的な使用権を付与し、著作者人格権を行使しないことに同意します。利用者は、利用者自身の書き込みが第三者によって無断で転載されることを防止するため、本サービスに書き込みを行う際には原則、本サービスならびに本サービスに関連するサービス以外への転載を許諾しないものとして書き込むことに同意します。</p>

                    <h3 class="text-lg font-semibold mb-4">第6条（違反行為への対応）</h3>
                    <p class="mb-4">本サービスの運営側は、利用者の書き込み内容が本規約に違反している、または不適切であると判断した場合、当該書き込みを事前通知なく削除する権利を有します。また、法執行機関や、名誉毀損や中傷に関する被害者からの正当な求めがあった場合、投稿内容の削除および発信者情報の開示に応じることがあります。また、違反行為を繰り返す利用者に対してはアカウントの一時停止などの措置を取ることがあります。</p>

                    <h3 class="text-lg font-semibold mb-4">第7条（免責事項）</h3>
                    <p class="mb-4">本サービスは、利用者が本サービスの利用に関連して被ったあらゆる損害等について、一切の責任を負いません。利用者は、自己の責任で本サービスを利用するものとし、運営側に対して一切の賠償請求を行わないものとします。</p>

                    <h3 class="text-lg font-semibold mb-4">第8条（規約の改定）</h3>
                    <p class="mb-6">本規約は、必要に応じて改定されることがあります。改定後の規約は、本サービス上に掲載された時点で効力を発生します。利用者は、定期的に本規約を確認する義務を負い、改定後も本サービスの利用を継続した場合、改定内容に同意したものとみなされます。</p>

                    <hr class="my-6" />

                    <p class="text-sm text-gray-600 mb-2"><strong>*1</strong> 例: hCaptcha, Cloudflare Turnstile, Spur</p>
                    <p class="text-sm text-gray-600 mb-4"><strong>*2</strong> 本サービスの運営者、もしくは運営者が委託する第三者が運営するサービス、加えていずれの場合も本サービスが使用するドメインを含むサービス</p>
                    
                    <hr class="my-6" />
                    
                    <p class="text-sm text-gray-600 mb-8">問い合わせ先: abuse あっとま～く eddibb.cc</p>
                    
                    <div id="scroll-indicator" class="text-center">
                        <p class="text-yellow-600 font-medium">規約をすべて読むために、最後までスクロールしてください</p>
                    </div>
                </div>
                
                <div class="p-6 border-t border-gray-200 flex justify-between items-center">
                    <button 
                        id="close-modal-btn" 
                        type="button"
                        class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium"
                    >
                        キャンセル
                    </button>
                    <button 
                        id="agree-btn" 
                        type="button"
                        disabled
                        class="px-6 py-2 bg-gray-400 text-white font-semibold rounded-lg cursor-not-allowed"
                    >
                        利用規約に同意する
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const showTouBtn = document.getElementById('show-tou-btn');
            const modal = document.getElementById('tou-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const agreeBtn = document.getElementById('agree-btn');
            const submitBtn = document.getElementById('submit-btn');
            const touStatus = document.getElementById('tou-status');
            const touContent = document.getElementById('tou-content');
            const scrollIndicator = document.getElementById('scroll-indicator');
            
            let hasScrolledToBottom = false;
            let hasAgreed = false;

            // Show modal when "利用規約を確認して同意する" is clicked
            showTouBtn.addEventListener('click', function() {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                checkScrollPosition();
            });

            // Close modal
            function closeModal() {
                modal.classList.add('hidden');
                document.body.style.overflow = 'auto';
            }

            closeModalBtn.addEventListener('click', closeModal);

            // Close modal when clicking outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Check if user has scrolled to the bottom
            function checkScrollPosition() {
                const scrollTop = touContent.scrollTop;
                const scrollHeight = touContent.scrollHeight;
                const clientHeight = touContent.clientHeight;
                
                if (scrollTop + clientHeight >= scrollHeight - 10) { // 10px tolerance
                    hasScrolledToBottom = true;
                    scrollIndicator.style.display = 'none';
                    agreeBtn.disabled = false;
                    agreeBtn.className = 'px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition duration-200';
                }
            }

            touContent.addEventListener('scroll', checkScrollPosition);

            // Handle agreement
            agreeBtn.addEventListener('click', function() {
                if (hasScrolledToBottom) {
                    hasAgreed = true;
                    closeModal();
                    
                    // Update UI
                    showTouBtn.parentElement.style.display = 'none';
                    touStatus.classList.remove('hidden');
                    
                    // Enable submit button
                    submitBtn.disabled = false;
                    submitBtn.className = 'w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 lg:text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2';
                }
            });

            // Prevent form submission if not agreed
            document.getElementById('login-form').addEventListener('submit', function(e) {
                if (!hasAgreed) {
                    e.preventDefault();
                    alert('利用規約に同意してください。');
                }
            });
        });
    </script>
</body>
</html>